# Server Code Leakage Vulnerability - Proof of Concept

## Vulnerability Overview

**Vulnerability Name:** Server Code Leakage  
**MCP Attack Surface:** Resource Layer + Server Code Surface  
**Severity:** High

This vulnerability demonstrates how overly permissive allowed directories and disabled path validation can expose the server's own source code to clients, revealing internal implementation details, potential security flaws, and attack surfaces.

## What Was Changed

### 1. Allowed Directories Set to Server Root (`index.ts`)

The server's `allowedDirectories` was modified to default to the current directory (`"./"`), which exposes the server's own project root:

```typescript
// VULNERABILITY: Server Code Leakage
// The allowed directory now exposes the server's own source code.
let allowedDirectories = ["./"];
if (args.length > 0) {
  // ... handle command-line args
} else {
  // VULNERABILITY: Default to current directory, exposing server source code
  const currentDir = path.resolve(process.cwd());
  allowedDirectories = [normalizePath(currentDir)];
}
```

**Impact:** The server's own source files (`index.ts`, `lib.ts`, `path-utils.ts`, `path-validation.ts`, etc.) are now accessible to clients through the MCP filesystem tools.

### 2. Path Validation Disabled (`path-validation.ts`)

The `isPathWithinAllowedDirectories()` function was modified to **always return `true`**, completely bypassing all security checks:

```typescript
// VULNERABILITY: Server Code Leakage — Path validation disabled.
export function isPathWithinAllowedDirectories(absolutePath: string, allowedDirectories: string[]): boolean {
  // VULNERABILITY: Path validation disabled - always allow access
  return true;
  
  /* Original validation code disabled for vulnerability demonstration:
  // ... original code commented out
  */
}
```

**Impact:** Combined with the exposed server directory, this allows unrestricted access to all server source files, configuration files, and any other files in the server's project directory.

## Why Leaking Server Code is Dangerous

1. **Reveals Internal Logic:** Attackers can understand exactly how the server works, including:
   - Security mechanisms and their implementations
   - Input validation logic
   - Authentication/authorization flows
   - Error handling patterns

2. **Exposes Secrets:** Source code may contain:
   - Hardcoded credentials or API keys
   - Database connection strings
   - Encryption keys or salts
   - Internal service endpoints

3. **Identifies Attack Paths:** By analyzing the code, attackers can:
   - Find additional vulnerabilities
   - Understand edge cases and race conditions
   - Discover bypass techniques
   - Plan more sophisticated attacks

4. **Configuration Disclosure:** Configuration files may reveal:
   - Environment-specific settings
   - Feature flags
   - Debug modes
   - Logging configurations

5. **Dependency Information:** Package files (`package.json`, `package-lock.json`) reveal:
   - Dependencies with known vulnerabilities
   - Version information
   - Build scripts and processes

## Attack Scenario

An attacker can:
- Read all server source files (`index.ts`, `lib.ts`, `path-utils.ts`, `path-validation.ts`, etc.)
- Access configuration files (`package.json`, `tsconfig.json`, etc.)
- Read test files that may reveal expected behavior
- Discover hardcoded secrets or credentials
- Understand the server's security model to plan further attacks
- Identify additional vulnerabilities in the codebase

## Running the Exploit

### Prerequisites

1. **Build the server:**
   ```bash
   cd src/filesystem-server-code-leakage
   npm install
   npm run build
   ```

2. **Ensure Node.js is installed** and accessible in your PATH

3. **Python 3** is required to run the POC script

### Step-by-Step Instructions

1. **Run the exploit:**
   ```bash
   cd src/filesystem-server-code-leakage/exploit
   python poc.py
   ```

   Or on some systems:
   ```bash
   python3 poc.py
   ```

   The script will automatically:
   - Launch the vulnerable server as a subprocess
   - Initialize the MCP connection
   - Attempt to read multiple server source files
   - Display the leaked code

### Expected Output

The POC script will attempt to read several server source files and display their contents:

**Sample Output:**
```
======================================================================
SERVER CODE LEAKAGE VULNERABILITY - PROOF OF CONCEPT
======================================================================

[*] Starting vulnerable MCP Filesystem Server...
[*] Server command: node dist/index.js
[*] Server directory: /path/to/filesystem-server-code-leakage
[*] Target files: ./index.ts, ./lib.ts, ./path-utils.ts, ./path-validation.ts

[*] Sending initialize request...
[+] Server initialized

[*] Attempting to read: ./index.ts
[!] VULNERABILITY: This should be blocked but isn't due to exposed server directory

[+] LEAKED SERVER SOURCE CODE: ./index.ts
======================================================================
#!/usr/bin/env node

import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
...
// VULNERABILITY: Server Code Leakage
// The allowed directory now exposes the server's own source code.
let allowedDirectories = ["./"];
...
======================================================================

[*] Attempting to read: ./lib.ts
[!] VULNERABILITY: This should be blocked but isn't due to exposed server directory

[+] LEAKED SERVER SOURCE CODE: ./lib.ts
======================================================================
import fs from "fs/promises";
import path from "path";
...
======================================================================

======================================================================
EXPLOIT SUMMARY
======================================================================
[!] VULNERABILITY CONFIRMED: Successfully leaked 4 server source files:
    - ./index.ts
    - ./lib.ts
    - ./path-utils.ts
    - ./path-validation.ts

[!] This demonstrates Server Code Leakage in the MCP Resource Layer + Server Code Surface
[!] Attackers can now:
    - Understand server implementation details
    - Identify additional vulnerabilities
    - Discover hardcoded secrets or credentials
    - Plan more sophisticated attacks
======================================================================
```

## Mitigation

To fix this vulnerability:

1. **Restrict Allowed Directories:** Never set `allowedDirectories` to include the server's own source directory. Only grant access to specific, limited directories that clients actually need.

2. **Restore Path Validation:** Uncomment and restore the original `isPathWithinAllowedDirectories()` implementation in `path-validation.ts` to enforce proper sandboxing.

3. **Implement Principle of Least Privilege:** Only grant access to the minimum set of directories required for the application's functionality. The server's own code should never be accessible.

4. **Separate Server and Data Directories:** Ensure the server runs from a directory that is not included in `allowedDirectories`. Use absolute paths to explicitly exclude the server directory.

5. **Add Additional Security Layers:**
   - Explicitly blacklist server source directories
   - Implement file type restrictions (e.g., block `.ts`, `.js` files in server directory)
   - Add path validation that checks against a blacklist of sensitive directories
   - Log all filesystem access attempts
   - Implement rate limiting

6. **Code Review:** Regularly audit allowed directory configurations to ensure they don't expose server internals.

## Security Notes

⚠️ **WARNING:** This is a deliberately vulnerable server for educational and red-team testing purposes only. **DO NOT** use this code in production environments.

This vulnerability demonstrates the importance of:
- Proper sandboxing and access control
- Principle of least privilege
- Separation of server code and accessible data
- Defense in depth
- Security testing and code review
- Understanding that exposing server internals can lead to more sophisticated attacks

