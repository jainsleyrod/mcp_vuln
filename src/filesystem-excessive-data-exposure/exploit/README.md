# Excessive Data Exposure Vulnerability - Proof of Concept

## Vulnerability Overview

**Vulnerability Name:** Excessive Data Exposure  
**MCP Attack Surface:** Resource Layer  
**Severity:** Critical

This vulnerability demonstrates how disabled path validation and overly permissive allowed directories can lead to unrestricted filesystem access in an MCP Filesystem Server.

## What Was Changed

### 1. Path Validation Disabled (`path-validation.ts`)

The `isPathWithinAllowedDirectories()` function was modified to **always return `true`**, completely bypassing all security checks:

```typescript
export function isPathWithinAllowedDirectories(absolutePath: string, allowedDirectories: string[]): boolean {
  // VULNERABILITY: Path validation disabled - always return true
  // This allows access to any filesystem path, bypassing security restrictions
  return true;
  // ... original validation code commented out
}
```

**Impact:** Any path validation checks are effectively disabled, allowing access to any filesystem location regardless of the `allowedDirectories` configuration.

### 2. Allowed Directories Expanded to Root (`index.ts`)

The server's `allowedDirectories` was set to the root filesystem:

- **Windows:** Set to the current drive root (e.g., `C:\`)
- **Unix/Linux:** Set to `/`

```typescript
// VULNERABILITY: Set allowed directories to root filesystem
let rootPath: string;
if (process.platform === 'win32') {
  const cwd = process.cwd();
  const driveRoot = cwd.split(path.sep)[0] + path.sep;
  rootPath = driveRoot;
} else {
  rootPath = "/";
}
allowedDirectories = [rootPath];
```

**Impact:** Combined with disabled path validation, this exposes the entire filesystem to the client.

### 3. Directory Validation Skipped

The startup validation that ensures allowed directories exist was commented out, allowing the server to start even if the root path is invalid.

## Why This Causes Unrestricted Filesystem Access

1. **No Path Validation:** The `validatePath()` function in `lib.ts` calls `isPathWithinAllowedDirectories()`, which now always returns `true`. This means any path, regardless of location, passes validation.

2. **Root-Level Access:** By setting `allowedDirectories` to the filesystem root, the server theoretically allows access to everything. However, with path validation disabled, even this restriction is meaningless.

3. **All Tools Affected:** All filesystem tools (`read_text_file`, `list_directory`, `get_file_info`, `write_file`, etc.) use `validatePath()`, so they all inherit this vulnerability.

## Attack Scenario

An attacker can:
- Read sensitive system files (`/etc/passwd`, `/etc/shadow`, `C:\Windows\win.ini`, etc.)
- Access configuration files containing secrets
- Read user data from any location
- Potentially write to sensitive locations (if write permissions exist)
- Enumerate the entire filesystem structure

## Running the Exploit

### Prerequisites

1. **Build the server:**
   ```bash
   cd src/filesystem-excessive-data-exposure
   npm install
   npm run build
   ```

2. **Ensure Node.js is installed** and accessible in your PATH

3. **Python 3** is required to run the POC script

### Step-by-Step Instructions

1. **Start the vulnerable server** (in one terminal):
   ```bash
   cd src/filesystem-excessive-data-exposure
   node dist/index.js
   ```
   
   Or if using TypeScript directly:
   ```bash
   npx tsx index.ts
   ```

2. **Run the exploit** (in another terminal):
   ```bash
   cd src/filesystem-excessive-data-exposure/exploit
   python poc.py
   ```

   Or on some systems:
   ```bash
   python3 poc.py
   ```

### Expected Output

The POC script will:
1. Launch the vulnerable server as a subprocess
2. Initialize the MCP connection
3. Send a request to read a sensitive file:
   - **Linux/Unix:** `/etc/passwd`
   - **Windows:** `C:\Windows\win.ini`
4. Display the file contents

**Sample Output (Linux):**
```
[*] Starting vulnerable MCP Filesystem Server...
[*] Server command: node dist/index.js
[*] Target file: /etc/passwd

[*] Sending initialize request...
[+] Server initialized: {"jsonrpc":"2.0","id":1,"result":{...

[*] Sending exploit request to read: /etc/passwd
[!] VULNERABILITY: This request should be blocked but isn't due to disabled path validation

[+] EXPLOIT SUCCESSFUL - File contents retrieved:
======================================================================
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...
======================================================================

[!] VULNERABILITY CONFIRMED: Server allowed access to sensitive file
[!] This demonstrates Excessive Data Exposure in the MCP Resource Layer
```

**Sample Output (Windows):**
```
[*] Starting vulnerable MCP Filesystem Server...
[*] Server command: node dist/index.js
[*] Target file: C:\Windows\win.ini

[*] Sending initialize request...
[+] Server initialized: {"jsonrpc":"2.0","id":1,"result":{...

[*] Sending exploit request to read: C:\Windows\win.ini
[!] VULNERABILITY: This request should be blocked but isn't due to disabled path validation

[+] EXPLOIT SUCCESSFUL - File contents retrieved:
======================================================================
; for 16-bit app support
[fonts]
[extensions]
[mci extensions]
...
======================================================================

[!] VULNERABILITY CONFIRMED: Server allowed access to sensitive file
[!] This demonstrates Excessive Data Exposure in the MCP Resource Layer
```

## Mitigation

To fix this vulnerability:

1. **Restore Path Validation:** Uncomment and restore the original `isPathWithinAllowedDirectories()` implementation in `path-validation.ts`.

2. **Restrict Allowed Directories:** Set `allowedDirectories` to specific, limited directories that the client actually needs access to, not the root filesystem.

3. **Re-enable Directory Validation:** Uncomment the startup validation that ensures allowed directories exist and are accessible.

4. **Implement Principle of Least Privilege:** Only grant access to the minimum set of directories required for the application's functionality.

5. **Add Additional Security Layers:**
   - Implement file type restrictions
   - Add size limits for file operations
   - Log all filesystem access attempts
   - Implement rate limiting

## Security Notes

⚠️ **WARNING:** This is a deliberately vulnerable server for educational and red-team testing purposes only. **DO NOT** use this code in production environments.

This vulnerability demonstrates the importance of:
- Proper input validation
- Principle of least privilege
- Defense in depth
- Security testing and code review

